name: Deploy Site

on:
 push:
  tags:
   - v*.*.*
 workflow_dispatch:

jobs:
 build-and-deploy:
  runs-on: ubuntu-latest

  steps:
   - name: Checkout code
     uses: actions/checkout@v4.1.7

   - name: Set up Node.js
     uses: actions/setup-node@v4.0.3
     with:
      node-version: "20"

   - name: Install dependencies
     run: npm install

   - name: Configure AWS credentials
     env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: ${{ secrets.AWS_REGION }}
     run: |
      aws configure set aws_access_key_id $AWS_ACCESS_KEY_ID
      aws configure set aws_secret_access_key $AWS_SECRET_ACCESS_KEY
      aws configure set default.region $AWS_REGION

   - name: Fetch JSON files from S3
     run: |
      aws s3 cp ${{ secrets.PORTFOLIO_DATA_S3_LINK }} src/lib --recursive --quiet

   - name: Build the site
     run: npm run build

   - name: Deploy to S3
     env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: ${{ secrets.AWS_REGION }}
     run: |
      aws s3 sync build/ ${{ secrets.PORTFOLIO_HOSTING_S3_LINK }} --delete --quiet

   - name: Invalidate CloudFront Cache
     env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: ${{ secrets.AWS_REGION }}
     run: |
      aws cloudfront create-invalidation --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} --paths "/*" --quiet
